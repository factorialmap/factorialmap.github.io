{
  "hash": "73396bd461c87d4cc9c105de057989ec",
  "result": {
    "markdown": "---\ntitle: \"Modelo preditivo | tidymodels decision tree rpart diabetes \"\nsubtitle: \"Modelo machine learning de árvore de decisão usando rpart, tidymodels e dados de diabetes\"\nauthor: \"Marcelo Carvalho dos Anjos\"\ndate: \"2022-11-28\"\ncategories: [Modelos]\nimage: \"decision_tree.png\"\nexecute: \n  output: FALSE\n---\n\n\n::: {.callout-tip appearance=\"simple\"}\nVídeo tema para este post em [Tidymodels decision tree model diabetes - rpart](https://youtu.be/p-wiv5wnLMw){target=\"_blank\"}\n:::\n\n### {{< fa 1 >}} [**O que é modelo de arvore de decisão**]{style=\"color: #5AC8BE ;\"}\n\n-   Decision tree models são modelos árvore de decisão baseadas em instruções **if-then**/**e se** utilizando os dados preditores. @kuhn2013, chap 8\n-   Exemplo: if temperatura_corporal \\>= 38 and dor_no_corpo = SIM then doente = SIM else doente = NAO\n-   O modelo que iremos usar é o rpart também conhecido por particionamento recursivo.\n\n### {{< fa 2 >}} [**Qual o objetivo**]{style=\"color: #5AC8BE ;\"}\n\n-   Prever a probabilidade de um paciente ter diabetes com base em medidas de diagnóstico incluídas no conjunto de dados.\n-   Todos os pacientes são mulheres de no mínimo 21 anos de idade e descendencia de Indios Pima\n-   Nos dados temos variáveis preditoras (independentes) e uma variável de resposta (dependente).\n-   Variáveis independentes incluem o número de gestações, massa(IMC), nível de insulina, idade, espessura da pele entre outras.\n\n### {{< fa 3 >}} [**De onde vem a demanda**]{style=\"color: #5AC8BE ;\"}\n\n-   Necessidade de praticar a construção de modelos machine learning usando o framework tidymodels.\n\n### {{< fa 4 >}} [**Como fazer**]{style=\"color: #5AC8BE ;\"}\n\n**Pacotes**\n\nPara reproduzir os códigos abaixo serão necessários os pacotes [tidyverse](https://www.tidyverse.org/){target=\"_blank\"} , [tidymodels](https://www.tidymodels.org/){target=\"_blank\"} e [janitor](https://github.com/sfirke/janitor){target=\"_blank\"}\n\n**Dados**\n\nO conjunto de dados é o Pima Indians Diabetes Database disponível na Universidade da California Irvine Machine Learning Repository, no [kaggle](https://www.kaggle.com/datasets/uciml/pima-indians-diabetes-database){target=\"_blank\"} e também no pacote `mlbench` no R. \n\n::: {.callout-tip collapse=\"true\"}\n## Clique aqui para mostrar dados complementares sobre Pima Indian Diabetes\n\n-   Pima US são povos indígenas, e hoje vivem principalmente em três reservas no Arizona: A Reserva do Rio Gila, A Reserva do Rio Salgado, A Reserva Ak-Chin\n\n-   Os índios Pima do Arizona são estudados por mais de 30 anos e intrigam os pesquisadores porque sofrem de uma das taxas mais altas de diabetes do mundo.\n\n-   Entre os índios Pima mexicanos, 5,6% dos homens e 8,5% das mulheres tinham diabetes, enquanto nos índios Pima do US 34,2% dos homens e 40,8% das mulheres tinham a doença (P \\< 0,01) prevalências significativamente maior nos americanos.\n\n-   Cerca de metade dos Pimas do Arizona com 40 anos ou mais tem diabetes de início adulto, uma condição na qual a insulina é produzida em quantidades insuficientes para atender às necessidades do corpo.\n\n-   Estão severamente acima do peso sendo os jovens estão acima da média nos EUA onde 1 a cada 4 são considerados obesos.\n\n-   Outro problema no grupo e insuficiência renal decorrente do diabetes sendo que 60% dos Pimas do Arizona desenvolvem doença renal relacionada ao diabetes contra 30% da população americana.\n\n-   Expectativa de vida dos Pima é muito menor do que a média nacional 72/M 78/F. Nos Pima 53/M e 63/F\n:::\n\n**Fluxo de trabalho**\n\n![](tidymodels_flowchart.png){width=\"1200\"}\n\n**Código reproduzível**\n\n\n::: {.cell filename='Packages'}\n\n```{.r .cell-code}\n# packages       ---------------------------------------------------------------\nlibrary(tidyverse)\nlibrary(tidymodels)\n```\n:::\n\n::: {.cell filename='Data'}\n\n```{.r .cell-code}\ndata(PimaIndiansDiabetes, package = \"mlbench\")\n\ndata_pima <- PimaIndiansDiabetes %>% janitor::clean_names()\n\ndata_pima %>% funModeling::df_status()\ndata_pima %>% funModeling::plot_num()\n\ndata_pima_clean <- \n  data_pima %>% \n  mutate(across(c(\"pregnant\":\"mass\"), ~ifelse(.x==0,NA,.x))) \n```\n:::\n\n::: {.cell filename='Explore'}\n\n```{.r .cell-code}\ndata_pima_clean %>% \n  select(glucose, insulin, mass, diabetes) %>% \n  GGally::ggpairs(aes(color = diabetes, alpha =0.3))\n```\n:::\n\n::: {.cell filename='Split the data'}\n\n```{.r .cell-code}\nsplit_pima <- initial_split(data_pima_clean, strata = diabetes)\ntrain_pima <- training(split_pima)\ntest_pima <- testing(split_pima)\n\nresample_pima <- vfold_cv(train_pima, strata = diabetes, v=5)\n```\n:::\n\n::: {.cell filename='Pre processing'}\n\n```{.r .cell-code}\nrec_pima <- \n  recipe(diabetes~., data = train_pima) %>% \n  step_impute_knn(all_predictors()) \n```\n:::\n\n::: {.cell filename='Model Specification'}\n\n```{.r .cell-code}\nmdl_spec_rpart_pima <- \n  decision_tree() %>% \n  set_engine(\"rpart\") %>% \n  set_mode(\"classification\") %>% \n  set_args(cost_complexity= tune(),\n           tree_depth = tune(),\n           min_n = tune())\n```\n:::\n\n::: {.cell filename='Model Workflow'}\n\n```{.r .cell-code}\nwkfl_rpart_pima <- \n  workflow() %>% \n  add_recipe(rec_pima) %>% \n  add_model(mdl_spec_rpart_pima)\n```\n:::\n\n::: {.cell filename='Hyperparameter tune'}\n\n```{.r .cell-code}\n# grid spec      ---------------------------------------------------------------\ngrid_pima <- \n  grid_regular(cost_complexity(),\n               tree_depth(),\n               min_n(),\n               levels = 3)\n\n# tune grid      ---------------------------------------------------------------\ndoParallel::registerDoParallel()\n\nset.seed(123)\ntune_grid_rpart_pima <- \n  tune_grid(wkfl_rpart_pima,\n            resamples = resample_pima,\n            grid = grid_pima,\n            metrics = metric_set(roc_auc,accuracy),\n            control = control_grid(save_pred = TRUE))\n\nbest_grid_rpart_pima <- tune_grid_rpart_pima %>% select_best(metric= \"roc_auc\")\n\n#final wkfl\nfinal_wkfl_rpart_pima <- \n  finalize_workflow(wkfl_rpart_pima, best_grid_rpart_pima)\n```\n:::\n\n::: {.cell filename='Model Evaluating'}\n\n```{.r .cell-code}\nmdl_eval_rpart_pima <- \n  final_wkfl_rpart_pima %>% \n  last_fit(split_pima)\n\nmdl_eval_rpart_pima %>% \n  extract_fit_engine() %>% \n  rpart.plot::rpart.plot(cex = 0.6,\n                         type = 3,\n                         roundint = FALSE)\n```\n:::\n\n::: {.cell filename='Model Fit'}\n\n```{.r .cell-code}\nmdl_fit_rpart_pima <- \n  final_wkfl_rpart_pima %>% \n  fit(data_pima_clean)\n```\n:::\n\n::: {.cell filename='Make predictions'}\n\n```{.r .cell-code}\nnew_data_pima <- \n  tribble(~pregnant, ~glucose, ~pressure,~triceps,~insulin, ~mass, ~pedigree, ~age,\n          2,87,68,34,77,38,0.41,25)\n\npredict(mdl_fit_rpart_pima, new_data = new_data_pima)\n\n\nmdl_fit_rpart_pima %>% \n  extract_fit_engine() %>% \n  vip::vip()\n```\n:::\n\n\n### {{< fa 5 >}} [**Pra onde vai quem é o cliente**]{style=\"color: #5AC8BE ;\"}\n\n-   Repositório de documento criados para praticar o desenvolvimento de modelos de previsão usando tidymodels.\n\n### {{< fa 6 >}} [**Qual o resultado**]{style=\"color: #5AC8BE ;\"}\n\n-   Aperfeiçoamento das técnicas de construção de modelos usando tidymodels.\n\n-   Criação de modelo de previsão que pode ser melhorado e aproveitado projetos futuros.\n\n-   Estimular a geração de ideias, dúvidas e conhecimento acerca do problema e também na construção de modelos de previsão.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}